# Union Types –≤ document_table

## üéØ –ß—Ç–æ —ç—Ç–æ?

**Union —Ç–∏–ø—ã** –ø–æ–∑–≤–æ–ª—è—é—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É JSON path –≤ `document_table`. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É, –∫–æ–≥–¥–∞ —Ä–∞–∑–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–ª—è, –Ω–æ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏.

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ (–¥–æ union —Ç–∏–ø–æ–≤)

```cpp
// –î–æ–∫—É–º–µ–Ω—Ç 1
{"age": 30}         // age - INTEGER

// –î–æ–∫—É–º–µ–Ω—Ç 2
{"age": "thirty"}   // age - STRING

// –†–µ–∑—É–ª—å—Ç–∞—Ç: üí• Exception: "Type mismatch for path 'age'"
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (—Å union —Ç–∏–ø–∞–º–∏)

```cpp
// –î–æ–∫—É–º–µ–Ω—Ç 1
{"age": 30}         // age - INTEGER

// –î–æ–∫—É–º–µ–Ω—Ç 2
{"age": "thirty"}   // age - STRING  ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç!

// –°—Ö–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: age: UNION[INTEGER, STRING]

// –î–æ–∫—É–º–µ–Ω—Ç 3
{"age": 30.5}       // age - DOUBLE  ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç!

// –°—Ö–µ–º–∞ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è: age: UNION[INTEGER, STRING, DOUBLE]
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```cpp
#include <components/document_table/document_table_storage.hpp>

// –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
auto storage = std::make_unique<document_table_storage_t>(resource, block_manager);

// –í—Å—Ç–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è union!
storage->insert(id1, create_document(R"({"field": 42})"));
storage->insert(id2, create_document(R"({"field": "text"})"));
storage->insert(id3, create_document(R"({"field": 3.14})"));

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è union
auto* col = storage->schema().get_column_info("field");
assert(col->is_union);
assert(col->union_types.size() == 3);  // INTEGER, STRING, DOUBLE
```

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ union

1. **–ü–µ—Ä–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç**: –∫–æ–ª–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –ø—Ä–æ—Å—Ç—ã–º —Ç–∏–ø–æ–º
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ç–∏–ø–æ–≤**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è union –∏–∑ –¥–≤—É—Ö —Ç–∏–ø–æ–≤
3. **–ù–æ–≤—ã–µ —Ç–∏–ø—ã**: union —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

```
Union = Tag + Values

Tag —É–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∏–ø (0, 1, 2, ...)
Values —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–¥–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ NULL

–ü—Ä–∏–º–µ—Ä: UNION[INT, STRING, DOUBLE]
- {tag: 0, value: 42,       NULL,     NULL}  // INTEGER
- {tag: 1, value: NULL, "text",      NULL}  // STRING
- {tag: 2, value: NULL,      NULL,    3.14}  // DOUBLE
```

## üé® API

### –ü—Ä–æ–≤–µ—Ä–∫–∞ union –∫–æ–ª–æ–Ω–∫–∏

```cpp
auto* col = schema.get_column_info("path");
if (col->is_union) {
    // –≠—Ç–æ union –∫–æ–ª–æ–Ω–∫–∞
    for (auto type : col->union_types) {
        // –ü–µ—Ä–µ–±–æ—Ä –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≤ union
    }
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ tag –¥–ª—è —Ç–∏–ø–∞

```cpp
uint8_t tag = schema.get_union_tag(col, logical_type::STRING);
// tag = –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –≤ union_types
```

## üìÇ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
components/document_table/
‚îú‚îÄ‚îÄ dynamic_schema.hpp           # ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã union –ø–æ–ª—è
‚îú‚îÄ‚îÄ dynamic_schema.cpp           # ‚úÖ –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è union
‚îú‚îÄ‚îÄ document_table_storage.hpp   # ‚úÖ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
‚îú‚îÄ‚îÄ document_table_storage.cpp   # ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ union –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ test_union_types.cpp     # ‚úÖ Comprehensive —Ç–µ—Å—Ç—ã
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd /home/tolisso/otterbrix/build
cmake --build . --target test_union_types
./components/document_table/tests/test_union_types
```

**10 —Ç–µ—Å—Ç–æ–≤ –ø–æ–∫—Ä—ã–≤–∞—é—Ç**:
- –°–æ–∑–¥–∞–Ω–∏–µ union –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ union –Ω–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å tag
- NULL –∑–Ω–∞—á–µ–Ω–∏—è
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
- –†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

## üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **union_types_integration_plan.md** - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- **union_types_progress.md** - –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **union_types_complete.md** - –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
- **README_UNION_TYPES.md** - –≠—Ç–æ—Ç —Ñ–∞–π–ª (quick start)

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ **–ö–æ–ª–æ–Ω–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**
- ‚úÖ **–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç**
- ‚úÖ **–ö–æ–º–ø—Ä–µ—Å—Å–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞**
- ‚ö†Ô∏è **–ù–µ–±–æ–ª—å—à–æ–π overhead**: tag + struct –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è

## üîç –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –°–º–µ—à–∞–Ω–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ —Ç–∏–ø—ã

```cpp
{"value": 42}          // INTEGER
{"value": 3.14}        // DOUBLE
{"value": 100000000}   // BIGINT

// –†–µ–∑—É–ª—å—Ç–∞—Ç: value: UNION[INTEGER, DOUBLE, BIGINT]
```

### –ü—Ä–∏–º–µ—Ä 2: –ß–∏—Å–ª–æ –∏ —Å—Ç—Ä–æ–∫–∞

```cpp
{"id": 123}      // INTEGER
{"id": "abc"}    // STRING

// –†–µ–∑—É–ª—å—Ç–∞—Ç: id: UNION[INTEGER, STRING]
```

### –ü—Ä–∏–º–µ—Ä 3: Boolean –∏ —Å—Ç—Ä–æ–∫–∞

```cpp
{"flag": true}   // BOOLEAN
{"flag": "yes"}  // STRING

// –†–µ–∑—É–ª—å—Ç–∞—Ç: flag: UNION[BOOLEAN, STRING]
```

## üéì –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Otterbrix

```cpp
// –°–æ–∑–¥–∞–Ω–∏–µ union —Ç–∏–ø–∞
types::complex_logical_type::create_union(types_vector);

// –°–æ–∑–¥–∞–Ω–∏–µ union –∑–Ω–∞—á–µ–Ω–∏—è
types::logical_value_t::create_union(types, tag, value);
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ column_info_t

```cpp
struct column_info_t {
    std::string json_path;
    types::complex_logical_type type;  // –ú–æ–∂–µ—Ç –±—ã—Ç—å UNION
    
    // Union support
    bool is_union = false;
    std::pmr::vector<types::logical_type> union_types;
    
    // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è ...
};
```

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏

1. **Nested structures**: Union –≤ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
2. **Array elements**: Union –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –º–∞—Å—Å–∏–≤–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏
3. **Eager conversion**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] Union –≤ nested —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö
- [ ] Union –≤ array —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∏–ø–æ–≤
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —á–∞—Å—Ç—ã—Ö —Ç–∏–ø–æ–≤
- [ ] Query predicates –¥–ª—è union –∫–æ–ª–æ–Ω–æ–∫

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞!**

---

**–î–∞—Ç–∞**: 30 –Ω–æ—è–±—Ä—è 2024  
**–í–µ—Ä—Å–∏—è**: 1.0

