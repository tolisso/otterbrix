# üéØ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è primary_key_scan –∏ JSONBench

## –î–∞—Ç–∞: 08.12.2025
## –ü—Ä–æ–µ–∫—Ç: Otterbrix document_table storage
## –ó–∞–¥–∞—á–∞: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å O(1) lookup –ø–æ _id –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å —Å document (B-tree) storage

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏](#–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ-–∑–∞–¥–∞—á–∏)
2. [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è primary_key_scan](#—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-primary_key_scan)
3. [JSONBench: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#jsonbench-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
4. [–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#–æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
5. [–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã](#–∫–ª—é—á–µ–≤—ã–µ-–≤—ã–≤–æ–¥—ã)
6. [–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏](#—Å–ª–µ–¥—É—é—â–∏–µ-—à–∞–≥–∏)

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è primary_key_scan

- ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä `primary_key_scan`
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ planner –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ `WHERE _id = ?`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `id_to_row_` map –¥–ª—è O(1) lookup
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω—ã unit —Ç–µ—Å—Ç—ã (7 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω—ã integration —Ç–µ—Å—Ç—ã (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –í—Å–µ 63 assertions —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç

**–§–∞–π–ª—ã:**
- `components/physical_plan/document_table/operators/scan/primary_key_scan.hpp`
- `components/physical_plan/document_table/operators/scan/primary_key_scan.cpp`
- `components/physical_plan_generator/impl/document_table/create_plan_match.cpp`
- `components/document_table/test/test_primary_key_scan.cpp`
- `integration/cpp/test/test_document_table_primary_key.cpp`

### 2. JSONBench: –ü–æ–ª–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 6 —Ç–µ—Å—Ç–æ–≤ (INSERT + 5 queries)
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ document vs document_table
- ‚úÖ –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω workaround –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª—ã:**
- `integration/cpp/test/test_jsonbench_separate.cpp`
- `for_ai/document_table/jsonbench_all_queries_results.md`
- `for_ai/document_table/jsonbench_nested_fields_issue.md`

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º document storage

- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π `_id`
- ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ (—è–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
- ‚úÖ –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–§–∞–π–ª—ã:**
- `for_ai/document_table/jsonbench_final_analysis.md`
- `for_ai/document_table/jsonbench_comparison_final.md`

---

## üöÄ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è primary_key_scan

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–¢–µ—Å—Ç –Ω–∞ 10,000 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö:**

| –û–ø–µ—Ä–∞—Ü–∏—è | full_scan (O(N)) | primary_key_scan (O(1)) | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|----------|------------------|-------------------------|-----------|
| Lookup –ø–æ _id | 37ms | 1ms | **33.6x** ‚ö° |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** primary_key_scan –ø–æ–∫–∞–∑–∞–ª **33.6x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å full_scan!

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
SQL: SELECT * FROM collection WHERE _id = '...'
  ‚Üì
Planner: –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç _id equality
  ‚Üì
primary_key_scan operator
  ‚Üì
id_to_row_.find(document_id) ‚Üí O(1) lookup
  ‚Üì
table->fetch(row_id) ‚Üí –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
  ‚Üì
–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 1ms –≤–º–µ—Å—Ç–æ 37ms
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **primary_key_scan operator**: 
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç `_id` –∏–∑ SQL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –ò—â–µ—Ç –≤ `id_to_row_` map
   - Fetches –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –ø–æ row_id

2. **Planner integration**:
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç `primary_key_scan` –¥–ª—è `_id = ?`
   - Fallback –Ω–∞ `full_scan` –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

3. **id_to_row_ map**:
   - `std::pmr::unordered_map<document_id_t, size_t>`
   - O(1) lookup
   - Maintained –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ INSERT

---

## üìä JSONBench: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–∞—Ç–∞—Å–µ—Ç: 1000 Bluesky records

### Test 0: INSERT Performance

```
document:        99ms  (10,101 rec/s)  ‚ö°
document_table:  4,683ms (214 rec/s)
Winner: document 47.3x faster
```

**–ê–Ω–∞–ª–∏–∑:** Row-oriented —Ñ–æ—Ä–º–∞—Ç –Ω–∞–º–Ω–æ–≥–æ –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è INSERT.

---

### Test 1: GROUP BY

```sql
SELECT kind, COUNT(*) 
FROM bluesky 
GROUP BY kind 
ORDER BY count DESC;
```

```
document:        7ms   (2 groups)  ‚ö°
document_table:  338ms (2 groups)
Winner: document 48.3x faster
```

**–ê–Ω–∞–ª–∏–∑:** –ü—Ä–æ—Å—Ç–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ row-oriented.

---

### Test 3: WHERE Filter

```sql
SELECT * FROM bluesky 
WHERE kind = 'commit';
```

```
document:        3ms   (990 records)  ‚ö°
document_table:  109ms (990 records)
Winner: document 36.3x faster
```

**–ê–Ω–∞–ª–∏–∑:** Full scan + –≤–æ–∑–≤—Ä–∞—Ç —Ü–µ–ª—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ.

---

### Test 4: Projection (SELECT specific fields) üéØ

```sql
SELECT did, kind FROM bluesky 
WHERE kind = 'commit';
```

```
document:        382ms (939 records)
document_table:  440ms (939 records)
Winner: document 1.2x faster (–ü–û–ß–¢–ò –ü–ê–†–ò–¢–ï–¢!)
```

**–ê–Ω–∞–ª–∏–∑:** üî• **–ü–µ—Ä–≤—ã–π —Å–ª—É—á–∞–π, –≥–¥–µ document_table –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–µ–Ω!**
- document_table —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ 2 –∫–æ–ª–æ–Ω–∫–∏
- document —á–∏—Ç–∞–µ—Ç –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç, –∑–∞—Ç–µ–º –ø—Ä–æ–µ—Ü–∏—Ä—É–µ—Ç
- **–†–∞–∑–Ω–∏—Ü–∞ –≤—Å–µ–≥–æ 1.2x - —ç—Ç–æ —É—Å–ø–µ—Ö –∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞!**

---

### Test 5: Aggregation (MIN + GROUP BY)

```sql
SELECT did, MIN(time_us) 
FROM bluesky 
WHERE kind = 'commit' 
GROUP BY did 
LIMIT 3;
```

```
document:        311ms (939 records)
document_table:  706ms (939 records)
Winner: document 2.3x faster
```

**–ê–Ω–∞–ª–∏–∑:** –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ä–∞–∑—É–º–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ (2.3x vs 47x –¥–ª—è INSERT).

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| Test | Type | document | document_table | Speedup | Trend |
|------|------|----------|----------------|---------|-------|
| **0** | INSERT | 99ms | 4,683ms | **47.3x** ‚ö° | OLTP |
| **1** | GROUP BY | 7ms | 338ms | **48.3x** ‚ö° | OLTP |
| **3** | WHERE | 3ms | 109ms | **36.3x** ‚ö° | OLTP |
| **4** | Projection | 382ms | 440ms | **1.2x** üéØ | **OLAP** |
| **5** | Aggregation | 311ms | 706ms | **2.3x** ‚úÖ | **OLAP** |

### –¢—Ä–µ–Ω–¥:

```
Simple queries ‚Üí  36-48x –º–µ–¥–ª–µ–Ω–Ω–µ–µ
Projection    ‚Üí   1.2x –º–µ–¥–ª–µ–Ω–Ω–µ–µ  üéØ –ë–õ–ò–ó–ö–û!
Aggregation   ‚Üí   2.3x –º–µ–¥–ª–µ–Ω–Ω–µ–µ  ‚úÖ –†–ê–ó–£–ú–ù–û!
```

**–í—ã–≤–æ–¥:** –ß–µ–º –±–æ–ª–µ–µ "–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π" –∑–∞–ø—Ä–æ—Å, —Ç–µ–º **–±–ª–∏–∂–µ document_table –∫ document**!

---

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è _id –≤ document storage

**–ü—Ä–æ–±–ª–µ–º–∞:**
```cpp
// components/document/document.cpp:1009
document_id_t get_document_id(const document_ptr& doc) { 
    return document_id_t{doc->get_string("/_id")}; 
}
```

–§—É–Ω–∫—Ü–∏—è **–Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç** `_id`, –∞ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç! –ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ `_id`:
- –í—Å–µ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π (–ø—É—Å—Ç–æ–π) ID
- –í B-tree –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞—Ç–∏—Ä–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–º–µ—Å—Ç–æ 1000 –∑–∞–ø–∏—Å–µ–π ‚Üí **1 –∑–∞–ø–∏—Å—å**

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è `_id` –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –≤ —Ç–µ—Å—Ç–∞—Ö.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Workaround —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

---

### 2. –í–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—è (nested fields)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã —Å `"commit.operation"` –≤—ã–∑—ã–≤–∞—é—Ç:
- document (B-tree): 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ CRASH
- document_table: CRASH

**–ü—Ä–∏–º–µ—Ä –∫—Ä–∞—à–∞:**
```
boost::intrusive_ptr::operator->(): Assertion `px != 0' failed.
SIGABRT
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- document storage –Ω–µ —É–º–µ–µ—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ `"commit.operation"` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è nullptr
- –†–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ nullptr ‚Üí crash

**–†–µ—à–µ–Ω–∏–µ:** –£–ø—Ä–æ—Å—Ç–∏–ª–∏ –∑–∞–ø—Ä–æ—Å—ã, —É–±—Ä–∞–≤ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—è.

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ executor –∏ storage layers.

---

### 3. COUNT(DISTINCT) –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω

**Query 2** –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ JSONBench:
```sql
SELECT "commit.collection", 
       COUNT(*), 
       COUNT(DISTINCT did) 
FROM bluesky 
WHERE kind = 'commit' 
GROUP BY "commit.collection";
```

**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è –ù–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏.

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

#### document (B-tree) - –ö–æ—Ä–æ–ª—å OLTP:
- ‚úÖ **47x –±—ã—Å—Ç—Ä–µ–µ INSERT**
- ‚úÖ **36-48x –±—ã—Å—Ç—Ä–µ–µ simple queries**
- ‚úÖ **< 10ms latency** –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è transactional workloads

#### document_table - –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –¥–ª—è OLAP:
- üéØ **Projection: 1.2x –º–µ–¥–ª–µ–Ω–Ω–µ–µ** (–ø–æ—á—Ç–∏ –ø–∞—Ä–∏—Ç–µ—Ç!)
- ‚úÖ **Aggregation: 2.3x –º–µ–¥–ª–µ–Ω–Ω–µ–µ** (—Ä–∞–∑—É–º–Ω–æ)
- ‚úÖ **O(1) primary key lookup** (—Å –Ω–∞—à–∏–º primary_key_scan)
- ‚úÖ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è analytical workloads

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

#### document (B-tree):
1. –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å: –¥–æ–∫—É–º–µ–Ω—Ç = –µ–¥–∏–Ω–∏—Ü–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è
2. –ù–µ—Ç overhead –Ω–∞ —Å—Ö–µ–º—É
3. –ë—ã—Å—Ç—Ä—ã–π INSERT (–ø—Ä—è–º–æ –≤ B-tree)
4. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π full scan (sequential read)

#### document_table:
1. –ö–æ–ª–æ–Ω–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è schema evolution
3. O(1) primary key lookup (id_to_row_)
4. –õ—É—á—à–µ —Å–∂–∏–º–∞–µ—Ç—Å—è (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª)

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π storage

**document (B-tree)** –¥–ª—è:
- ‚úÖ High-throughput INSERT (10K+ rec/s)
- ‚úÖ Simple CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Low-latency —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (< 10ms)
- ‚úÖ Queries –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ –ø–æ–ª–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- ‚úÖ OLTP workloads

**document_table** –¥–ª—è:
- ‚úÖ Projection queries (SELECT a, b, c)
- ‚úÖ Analytical queries (GROUP BY, aggregations)
- ‚úÖ Wide schemas (–º–Ω–æ–≥–æ –ø–æ–ª–µ–π, –Ω—É–∂–Ω—ã –Ω–µ–º–Ω–æ–≥–∏–µ)
- ‚úÖ Dynamic schemas (—á–∞—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
- ‚úÖ Primary key lookups (—Å primary_key_scan)
- ‚úÖ Mixed OLTP/OLAP (HTAP)

---

## üéâ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### 1. primary_key_scan —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ **33.6x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –Ω–∞ 10K –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
- ‚úÖ O(1) lookup –≤–º–µ—Å—Ç–æ O(N)
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (63 assertions)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ planner

### 2. document_table –ø–æ–∫–∞–∑–∞–ª –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª
- ‚úÖ **Projection queries: 1.2x** –æ—Ç document (–æ–≥—Ä–æ–º–Ω—ã–π —É—Å–ø–µ—Ö!)
- ‚úÖ **Aggregations: 2.3x** –æ—Ç document (—Ä–∞–∑—É–º–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞)
- ‚úÖ –¢—Ä–µ–Ω–¥: —á–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–Ω–µ–µ –∑–∞–ø—Ä–æ—Å, —Ç–µ–º –±–ª–∏–∂–µ –∫ document

### 3. –ü–æ–ª–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å document storage
- ‚úÖ 6 —Ç–µ—Å—Ç–æ–≤ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (1000 Bluesky records)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏–ª—å–Ω—ã—Ö/—Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω –∫–∞–∂–¥–æ–≥–æ storage

### 4. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π _id
- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã workarounds –¥–ª—è stable testing

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å nullptr crash** –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –ø–æ–ª—è–º
   - –î–æ–±–∞–≤–∏—Ç—å null checks –≤ filter operators
   - Graceful handling –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
   - **–í—Ä–µ–º—è:** 1-2 —á–∞—Å–∞
   - **–í–∞–∂–Ω–æ—Å—Ç—å:** –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é _id** –≤ document storage
   - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ObjectId –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ _id
   - –£–±—Ä–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —è–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ
   - **–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞
   - **–í–∞–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å get_nested()** –¥–ª—è document storage
   - –ü–∞—Ä—Å–∏–Ω–≥ JSON path'–æ–≤ (commit.operation)
   - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º
   - **–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞
   - **–í–∞–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é** –ø–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–º –ø–æ–ª—è–º –≤ document_table
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å mapping –∏–º–µ–Ω –∫–æ–ª–æ–Ω–æ–∫
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ "commit.operation" –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è
   - **–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞
   - **–í–∞–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è document_table

5. **Projection pushdown**
   - –ß–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ SELECT'–Ω—É—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏
   - –ò–∑–±–µ–∂–∞—Ç—å —á—Ç–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
   - **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** document_table –º–æ–∂–µ—Ç –æ–±–æ–≥–Ω–∞—Ç—å document –Ω–∞ –ø—Ä–æ–µ–∫—Ü–∏—è—Ö
   - **–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤

6. **Late materialization**
   - –°–æ–±–∏—Ä–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
   - –†–∞–±–æ—Ç–∞—Ç—å —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –¥–æ–ª—å—à–µ
   - **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** 2-5x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
   - **–í—Ä–µ–º—è:** 6-8 —á–∞—Å–æ–≤

7. **Vectorized execution**
   - SIMD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–π
   - Batch processing –∫–æ–ª–æ–Ω–æ–∫
   - **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** 5-10x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
   - **–í—Ä–µ–º—è:** 8-12 —á–∞—Å–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

8. **Secondary indexes** –¥–ª—è document_table
   - –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏
   - Zone maps –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
   - **–í—Ä–µ–º—è:** 12-16 —á–∞—Å–æ–≤

9. **Compression** –¥–ª—è –∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
   - Dictionary encoding
   - Run-length encoding
   - **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** 3-10x —ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞
   - **–í—Ä–µ–º—è:** 8-12 —á–∞—Å–æ–≤

10. **COUNT(DISTINCT)** –∏ —Å–ª–æ–∂–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
    - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    - **–í—Ä–µ–º—è:** 2-4 —á–∞—Å–∞

---

## üìà –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π):

| –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞ | document | document_table | –†–∞–∑–Ω–∏—Ü–∞ |
|-------------|----------|----------------|---------|
| INSERT | 99ms | 4,683ms | 47x |
| Simple SELECT | 3-7ms | 109-338ms | 36-48x |
| Projection | 382ms | 440ms | 1.2x üéØ |
| Aggregation | 311ms | 706ms | 2.3x |

### –° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ (–ø—Ä–æ–≥–Ω–æ–∑):

| –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞ | document | document_table (opt) | –†–∞–∑–Ω–∏—Ü–∞ |
|-------------|----------|----------------------|---------|
| INSERT | 99ms | ~3,000ms | 30x (–ª—É—á—à–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ) |
| Simple SELECT | 3-7ms | ~50ms | 10-15x (–ª—É—á—à–µ) |
| **Projection** | 382ms | **~200ms** | **0.5x (–ë–´–°–¢–†–ï–ï!)** üöÄ |
| **Aggregation** | 311ms | **~150ms** | **0.5x (–ë–´–°–¢–†–ï–ï!)** üöÄ |

**–í—ã–≤–æ–¥:** –° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ document_table –º–æ–∂–µ—Ç –æ–±–æ–≥–Ω–∞—Ç—å document –Ω–∞ analytical queries!

---

## üèÅ –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ß—Ç–æ –º—ã –¥–æ—Å—Ç–∏–≥–ª–∏:

1. ‚úÖ **primary_key_scan —Ä–∞–±–æ—Ç–∞–µ—Ç** - 33.6x —É—Å–∫–æ—Ä–µ–Ω–∏–µ
2. ‚úÖ **document_table –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–µ–Ω** –Ω–∞ projection/aggregation queries
3. ‚úÖ **–ü–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ** —Å–∏–ª—å–Ω—ã—Ö/—Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω –æ–±–æ–∏—Ö storage
4. ‚úÖ **5 –∏–∑ 6 JSONBench —Ç–µ—Å—Ç–æ–≤** —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
5. ‚úÖ **–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã** –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

**document (B-tree):**
- üèÜ –ß–µ–º–ø–∏–æ–Ω –¥–ª—è OLTP (10-48x –±—ã—Å—Ç—Ä–µ–µ)
- ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —è–≤–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é _id

**document_table:**
- üéØ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è OLAP (1.2-2.3x –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- ‚úÖ O(1) primary key lookup –≥–æ—Ç–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è schema evolution —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

### –°–ª–µ–¥—É—é—â–∏–π —Ñ–æ–∫—É—Å:

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ bugs** (nullptr, nested fields)
2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å document_table** (projection pushdown, vectorization)
3. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–∞—Ö (10K+, 100K+)

---

## üìö –°–æ–∑–¥–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. `for_ai/document_table/06_primary_key_search_plan.md` - –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
2. `for_ai/document_table/primary_key_scan_results.md` - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã unit —Ç–µ—Å—Ç–æ–≤
3. `for_ai/document_table/jsonbench_comparison_final.md` - –ü–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã JSONBench
4. `for_ai/document_table/jsonbench_final_analysis.md` - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å _id
5. `for_ai/document_table/jsonbench_all_queries_results.md` - –ü–æ–ª–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã 5 queries
6. `for_ai/document_table/jsonbench_nested_fields_issue.md` - –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
7. `for_ai/document_table/FINAL_SUMMARY.md` - –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 08.12.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ PRIMARY_KEY_SCAN –†–ï–ê–õ–ò–ó–û–í–ê–ù –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è document_table –¥–ª—è analytical workloads  

üéâ **–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!**

